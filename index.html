<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Sterownik Akwarystyczny (MQTT)</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f8ff; margin: 20px; }
    h1 { color: #0066cc; }
    h2 { color: #004c99; }
    .section { background: #ffffff; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0px 2px 5px rgba(0,0,0,0.1); }
    a.button, button { display: inline-block; padding: 8px 12px; margin: 4px 2px; background: #0066cc; color: white; text-decoration: none; border: none; border-radius: 4px; cursor: pointer; }
    a.button:hover, button:hover { background: #004c99; }
    input[type='text'] { padding: 5px; border: 1px solid #ccc; border-radius: 4px; width: 40px; }
  </style>
</head>
<body>

<h1>Sterownik Akwarystyczny (MQTT)</h1>
<p>Czas lokalny: <strong><span id="localTime">--:--</span></strong></p>

<div class="section">
  <h2>Oświetlenie</h2>
  <button onclick="publish('aquarium/light', 'on')">Włącz</button>
  <button onclick="publish('aquarium/light', 'off')">Wyłącz</button>
</div>

<div class="section">
  <h2>Grzałka</h2>
  <p>Aktualna temperatura: <strong><span id="temp">--</span> °C</strong></p>
  <p>Temperatura zadana: <strong><span id="target">--</span> °C</strong></p>
  <p>Ustaw nową temperaturę: <input type="text" id="setTemp"> <button onclick="setHeater()">Ustaw</button></p>
</div>

<div class="section">
  <h2>Pompka</h2>
  <button onclick="publish('aquarium/pump', 'on')">Włącz</button>
  <button onclick="publish('aquarium/pump', 'off')">Wyłącz</button>
</div>

<div class="section">
  <h2>Karmienie</h2>
  <p>Karmienie 1: <strong><span id="feed1">--:--</span></strong></p>
  <p>Karmienie 2: <strong><span id="feed2">--:--</span></strong></p>
  <p>Odliczanie do następnego karmienia: <strong><span id="nextFeed">--:--</span></strong></p>
  <p>
    Karmienie 1 - Godzina: <input type="text" id="h1"> Minuta: <input type="text" id="m1"><br>
    Karmienie 2 - Godzina: <input type="text" id="h2"> Minuta: <input type="text" id="m2">
    <button onclick="setFeedTimes()">Ustaw godziny</button>
  </p>
  <button onclick="publish('aquarium/feed', 'now')">Podaj pokarm (manualnie)</button>
</div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  let feed1Time = "--:--";
  let feed2Time = "--:--";

  const client = mqtt.connect("wss://58ec15cbf38243588a5903e2ad4e9c1c.s1.eu.hivemq.cloud:8884/mqtt", {
    clientId: "WebClient_" + Math.random().toString(16).substr(2, 8),
    username: "TWOJ_LOGIN",
    password: "TWOJE_HASLO"
  });

  client.on("connect", () => {
    console.log("Połączono z MQTT");
    client.subscribe("aquarium/status");
  });

  client.on("message", (topic, message) => {
    if (topic === "aquarium/status") {
      const data = JSON.parse(message.toString());
      document.getElementById("temp").innerText = data.temp.toFixed(1);
      document.getElementById("target").innerText = data.target.toFixed(1);
      if (data.time) document.getElementById("localTime").innerText = data.time;

      // Oblicz i pokaż feed times jeśli zostały zapisane
      if (localStorage.getItem("feed1")) document.getElementById("feed1").innerText = localStorage.getItem("feed1");
      if (localStorage.getItem("feed2")) document.getElementById("feed2").innerText = localStorage.getItem("feed2");

      updateCountdown();
    }
  });

  function publish(topic, message) {
    client.publish(topic, message);
  }

  function setHeater() {
    const val = document.getElementById("setTemp").value;
    if (val) publish("aquarium/heater/set", val);
  }

  function setFeedTimes() {
    const h1 = document.getElementById("h1").value.padStart(2, '0');
    const m1 = document.getElementById("m1").value.padStart(2, '0');
    const h2 = document.getElementById("h2").value.padStart(2, '0');
    const m2 = document.getElementById("m2").value.padStart(2, '0');

    const msg = `${h1},${m1},${h2},${m2}`;
    publish("aquarium/feedtimes/set", msg);

    const f1 = `${h1}:${m1}`;
    const f2 = `${h2}:${m2}`;
    document.getElementById("feed1").innerText = f1;
    document.getElementById("feed2").innerText = f2;
    localStorage.setItem("feed1", f1);
    localStorage.setItem("feed2", f2);

    updateCountdown();
  }

  function updateCountdown() {
    const now = new Date();
    const currentSec = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();

    const feed1Str = localStorage.getItem("feed1");
    const feed2Str = localStorage.getItem("feed2");
    if (!feed1Str || !feed2Str) return;

    const [h1, m1] = feed1Str.split(":".padStart(2, '0')).map(Number);
    const [h2, m2] = feed2Str.split(":".padStart(2, '0')).map(Number);
    const f1 = h1 * 3600 + m1 * 60;
    const f2 = h2 * 3600 + m2 * 60;

    let nextFeedSec = f1 > currentSec ? f1 : (f2 > currentSec ? f2 : f1 + 24 * 3600);
    let diff = nextFeedSec - currentSec;

    const hours = Math.floor(diff / 3600);
    const minutes = Math.floor((diff % 3600) / 60);
    const seconds = diff % 60;
    const countdownStr = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

    document.getElementById("nextFeed").innerText = countdownStr;
  }

  setInterval(updateCountdown, 1000);
</script>

</body>
</html>
