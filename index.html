<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sterownik Akwarystyczny (MQTT)</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f8ff; margin: 20px; }
    h1 { color: #0066cc; }
    h2 { color: #004c99; }
    .section { background: #ffffff; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0px 2px 5px rgba(0,0,0,0.1); }
    button { padding: 8px 12px; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #004c99; }
    input[type='text'] { padding: 5px; border: 1px solid #ccc; border-radius: 4px; width: 40px; }
  </style>
</head>
<body>
<h1>Sterownik Akwarystyczny (MQTT)</h1>
<p>Czas lokalny: <strong><span id="localTime">--:--</span></strong></p>
<div class="section">
  <h2>Oświetlenie</h2>
  <button onclick="publish('aquarium/light', 'on')">Włącz</button>
  <button onclick="publish('aquarium/light', 'off')">Wyłącz</button>
</div>
<div class="section">
  <h2>Grzałka</h2>
  <p>Aktualna temperatura: <strong><span id="temp">--</span> °C</strong></p>
  <p>Temperatura zadana: <strong><span id="target">--</span> °C</strong></p>
  <p>Nowa temperatura: <input type="text" id="setTemp"> <button onclick="setHeater()">Ustaw</button></p>
</div>
<div class="section">
  <h2>Pompka</h2>
  <button onclick="publish('aquarium/pump', 'on')">Włącz</button>
  <button onclick="publish('aquarium/pump', 'off')">Wyłącz</button>
</div>
<div class="section">
  <h2>Karmienie</h2>
  <p>Karmienie 1: <strong><span id="feed1">--:--</span></strong></p>
  <p>Karmienie 2: <strong><span id="feed2">--:--</span></strong></p>
  <p>Odliczanie: <strong><span id="nextFeed">--:--</span></strong></p>
  <button onclick="feedNow()">Podaj pokarm</button>
</div>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  let feed1Str = "--:--";
  let feed2Str = "--:--";
  const client = mqtt.connect("wss://58ec15cbf38243588a5903e2ad4e9c1c.s1.eu.hivemq.cloud:8884/mqtt", {
    clientId: "WebClient_" + Math.random().toString(16).substr(2, 8),
    username: "Strona",
    password: "Haslo123"
  });
  client.on("connect", () => {
    client.subscribe("aquarium/status");
    client.subscribe("aquarium/feedtimes/status");
    client.subscribe("aquarium/feed/confirm");
  });
  client.on("message", (topic, message) => {
    const data = JSON.parse(message.toString());
    if (topic === "aquarium/status") {
      document.getElementById("temp").innerText = data.temp.toFixed(1);
      document.getElementById("target").innerText = data.target.toFixed(1);
      if (data.time) document.getElementById("localTime").innerText = data.time;
    }
    if (topic === "aquarium/feedtimes/status") {
      feed1Str = data.feed1;
      feed2Str = data.feed2;
      document.getElementById("feed1").innerText = feed1Str;
      document.getElementById("feed2").innerText = feed2Str;
    }
    if (topic === "aquarium/feed/confirm") {
      alert("Pokarm został podany!");
    }
  });
  function publish(topic, message) {
    client.publish(topic, message);
  }
  function setHeater() {
    const temp = document.getElementById("setTemp").value;
    if (temp) publish("aquarium/heater/set", temp);
  }
  function feedNow() {
    publish("aquarium/feed", "now");
  }
  function updateCountdown() {
    if (feed1Str === "--:--" || feed2Str === "--:--") return;
    const now = new Date();
    const current = now.getHours() * 60 + now.getMinutes();
    const [h1, m1] = feed1Str.split(":" ).map(Number);
    const [h2, m2] = feed2Str.split(":" ).map(Number);
    const f1 = h1 * 60 + m1;
    const f2 = h2 * 60 + m2;
    let next;
    if (current < f1) {
      next = f1;
    } else if (current < f2) {
      next = f2;
    } else {
      next = f1 + 1440;
    }
    const diff = next - current;
    const hours = Math.floor(diff / 60);
    const mins = diff % 60;
    document.getElementById("nextFeed").innerText = `${hours}:${mins.toString().padStart(2, '0')}`;
  }
  setInterval(updateCountdown, 1000);
</script>
</body>
</html>
